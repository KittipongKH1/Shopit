<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{base::layout(~{::section})}">

<section th:fragment="section">
  <div class="container-fluid mt-5 py-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="fw-bold text-gradient mb-0">All Orders</h3>
      <a href="/admin/" class="btn btn-outline-purple fw-semibold">
        <i class="fa-solid fa-arrow-left me-2"></i> Back
      </a>
    </div>

    <!-- Success / Error Message -->
    <div class="text-center">
      <th:block th:if="${session.succMsg}">
        <p class="text-success fw-semibold mb-2">[[${session.succMsg}]]</p>
        <th:block th:text="${@commnServiceImpl.removeSessionMessage()}"></th:block>
      </th:block>

      <th:block th:if="${session.errorMsg}">
        <p class="text-danger fw-semibold mb-2">[[${session.errorMsg}]]</p>
        <th:block th:text="${@commnServiceImpl.removeSessionMessage()}"></th:block>
      </th:block>
    </div>

    <!-- Search Box -->
    <div class="col-md-5 mb-4">
      <form action="/admin/search-order" method="get" class="shadow-sm p-3 bg-white rounded-4">
        <div class="row g-2 align-items-center">
          <div class="col">
            <input type="text" class="form-control form-control-lg" name="orderId" placeholder="🔍 Enter order ID">
          </div>
          <div class="col-auto">
            <button class="btn btn-purple px-4 py-2 fw-semibold">
              <i class="fa-solid fa-magnifying-glass me-1"></i> Search
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- Orders Table -->
    <div class="card border-0 shadow-lg rounded-4 p-3">
      <div class="table-responsive">
        <table class="table align-middle table-hover text-center">
          <thead class="table-light">
            <tr class="text-purple">
              <th>Order ID</th>
              <th>Deliver Details</th>
              <th>Date</th>
              <th>Product Details</th>
              <th>Price</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>

          <tbody>
            <!-- If search mode -->
            <th:block th:if="${srch}">
              <th:block th:if="${orderDtls!=null}">
                <tr>
                  <td>[[${orderDtls.orderId}]]</td>
                  <td class="text-start small">
                    <b>Name:</b> [[${orderDtls.orderAddress.firstName+' '+orderDtls.orderAddress.lastName}]]<br>
                    <b>Email:</b> [[${orderDtls.orderAddress.email}]]<br>
                    <b>Mobile:</b> [[${orderDtls.orderAddress.mobileNo}]]<br>
                    <b>Address:</b> [[${orderDtls.orderAddress.address}]], [[${orderDtls.orderAddress.city}]], [[${orderDtls.orderAddress.state}]] - [[${orderDtls.orderAddress.pincode}]]
                  </td>
                  <td>[[${orderDtls.orderDate}]]</td>
                  <td>[[${orderDtls.product.title}]]</td>
                  <td>
                    Qty: [[${orderDtls.quantity}]] <br>
                    Price: [[${orderDtls.price}]] <br>
                    <b>Total:</b> [[${orderDtls.quantity * orderDtls.price}]]
                  </td>
                  <td><span class="badge bg-purple text-white px-3 py-2">[[${orderDtls.status}]]</span></td>
                  <td>
                    <form action="/admin/update-order-status" method="post">
                      <div class="row g-2">
                        <div class="col">
                          <select class="form-select" name="st">
                            <option>--select--</option>
                            <option value="1">In Progress</option>
                            <option value="2">Order Received</option>
                            <option value="3">Product Packed</option>
                            <option value="4">Out for Delivery</option>
                            <option value="5">Delivered</option>
                            <option value="6">Cancelled</option>
                          </select>
                        </div>
                        <input th:value="${orderDtls.id}" name="id" type="hidden">
                        <div class="col">
                          <th:block th:if="${orderDtls.status=='Cancelled' || orderDtls.status=='Delivered'}">
                            <button class="btn btn-purple disabled w-100">Update</button>
                          </th:block>
                          <th:block th:unless="${orderDtls.status=='Cancelled' || orderDtls.status=='Delivered'}">
                            <button class="btn btn-purple w-100">Update</button>
                          </th:block>
                        </div>
                      </div>
                    </form>
                  </td>
                </tr>
              </th:block>
              <th:block th:unless="${orderDtls!=null}">
                <tr>
                  <td colspan="7" class="text-danger fs-5 fw-semibold">[[${errorMsg}]]</td>
                </tr>
              </th:block>
            </th:block>

            <!-- If not search -->
            <th:block th:unless="${srch}">
              <tr th:each="o:${orders}">
                <td>[[${o.orderId}]]</td>
                <td class="text-start small">
                  <b>Name:</b> [[${o.orderAddress.firstName+' '+o.orderAddress.lastName}]]<br>
                  <b>Email:</b> [[${o.orderAddress.email}]]<br>
                  <b>Mobile:</b> [[${o.orderAddress.mobileNo}]]<br>
                  <b>Address:</b> [[${o.orderAddress.address}]], [[${o.orderAddress.city}]], [[${o.orderAddress.state}]] - [[${o.orderAddress.pincode}]]
                </td>
                <td>[[${o.orderDate}]]</td>
                <td>[[${o.product.title}]]</td>
                <td>
                  Qty: [[${o.quantity}]] <br>
                  Price: [[${o.price}]] <br>
                  <b>Total:</b> [[${o.quantity * o.price}]]
                </td>
                <td><span class="badge bg-purple text-white px-3 py-2">[[${o.status}]]</span></td>
                <td>
                  <form action="/admin/update-order-status" method="post">
                    <div class="row g-2">
                      <div class="col">
                        <select class="form-select" name="st">
                          <option>--select--</option>
                          <option value="1">In Progress</option>
                          <option value="2">Order Received</option>
                          <option value="3">Product Packed</option>
                          <option value="4">Out for Delivery</option>
                          <option value="5">Delivered</option>
                          <option value="6">Cancelled</option>
                        </select>
                      </div>
                      <input th:value="${o.id}" name="id" type="hidden">
                      <div class="col">
                        <th:block th:if="${o.status=='Cancelled' || o.status=='Delivered'}">
                          <button class="btn btn-purple disabled w-100">Update</button>
                        </th:block>
                        <th:block th:unless="${o.status=='Cancelled' || o.status=='Delivered'}">
                          <button class="btn btn-purple w-100">Update</button>
                        </th:block>
                      </div>
                    </div>
                  </form>
                </td>
              </tr>
            </th:block>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <th:block th:if="${!srch}">
        <div class="d-flex justify-content-between align-items-center mt-4">
          <p class="mb-0 fw-semibold">Total Orders: [[${totalElements}]]</p>
          <nav>
            <ul class="pagination mb-0">
              <li class="page-item" th:classappend="${isFirst}? 'disabled'">
                <a class="page-link" th:href="@{'/admin/orders?pageNo='+${pageNo-1}}">&laquo;</a>
              </li>

              <li th:each="i:${#numbers.sequence(1,totalPages)}" class="page-item" th:classappend="${pageNo+1==i}?'active':''">
                <a class="page-link" th:href="@{'/admin/orders?pageNo='+${i-1}}">[[${i}]]</a>
              </li>

              <li class="page-item" th:classappend="${isLast}? 'disabled'">
                <a class="page-link" th:href="@{'/admin/orders?pageNo='+${pageNo+1}}">&raquo;</a>
              </li>
            </ul>
          </nav>
        </div>
      </th:block>
    </div>
  </div>

  <!-- 💅 CSS -->
  <style>
    body {
      background-color: #f9f8ff;
      font-family: 'Poppins', sans-serif;
    }

    .text-gradient {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .text-purple {
      color: #4c1d95;
    }

    .bg-purple {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    }

    .btn-purple {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: white;
      border: none;
      border-radius: 10px;
      transition: 0.3s ease;
    }

    .btn-purple:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(124, 58, 237, 0.4);
    }

    .btn-outline-purple {
      border: 2px solid #8b5cf6;
      color: #7c3aed;
      border-radius: 10px;
      transition: 0.3s ease;
      background-color: #fff;
    }

    .btn-outline-purple:hover {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
    }

    table th {
      font-weight: 600;
    }

    .form-select, .form-control {
      border-radius: 10px;
      border: 1px solid #e0e0e0;
      padding: 0.5rem 0.75rem;
    }

    .form-control:focus, .form-select:focus {
      border-color: #8b5cf6;
      box-shadow: 0 0 0 0.2rem rgba(139, 92, 246, 0.25);
    }

    .card {
      background: white;
    }
  </style>
</section>
</html>
